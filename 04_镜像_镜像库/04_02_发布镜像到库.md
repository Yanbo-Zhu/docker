
# 1 本地镜像发布到阿里云 

![](image/Pasted%20image%2020240208115717.png)

## 1.1 镜像的生成方法
·	上一讲已经介绍过
·	基于当前容器创建一个新的镜像，新功能增强 docker commit [OPTIONS] 容器ID [REPOSITORY[:TAG]]
OPTIONS说明：
-a :提交的镜像作者；
-m :提交时的说明文字；
本次案例centos+ubuntu两个，当堂讲解一个，家庭作业一个，请大家务必动手，亲自实操。

![](image/Pasted%20image%2020240208114219.png)

![](image/Pasted%20image%2020240208114228.png)
  
## 1.2 **本地镜像发布到阿里云流程**

![graphic](file:///C:/Users/yzh/AppData/Local/Temp/msohtmlclip1/01/clip_image004.jpg)


·   本地镜像素材原型

![](image/Pasted%20image%2020240208114335.png)

![](image/Pasted%20image%2020240208114339.png)


阿里云开发者平台

 https://promotion.aliyun.com/ntms/act/kubernetes.html

![](image/Pasted%20image%2020240208114402.png)


 创建仓库镜像
![](image/Pasted%20image%2020240208114442.png)

·          选择控制台，进入容器镜像服务

·          选择个人实例

·          命名空间

·          继续

·          仓库名称

·          继续

·          进入管理界面获得脚本

将镜像推送到阿里云

·          将镜像推送到阿里云registry

·          管理界面脚本
![](image/Pasted%20image%2020240208114524.png)

·          脚本实例

docker login --username=zzyybuy registry.cn-hangzhou.aliyuncs.com
docker tag cea1bb40441c registry.cn-hangzhou.aliyuncs.com/atguiguwh/myubuntu:1.1
docker push registry.cn-hangzhou.aliyuncs.com/atguiguwh/myubuntu:1.1

![](image/Pasted%20image%2020240208114606.png)

## 1.3 **将阿里云上的镜像下载到本地**

下载到本地

![](image/Pasted%20image%2020240208114623.png)

docker pull registry.cn-hangzhou.aliyuncs.com/atguiguwh/myubuntu:1.1

# 2 	本地镜像发布到私有库


![](image/Pasted%20image%2020240208115545.png)


1 官方Docker Hub地址：https://hub.docker.com/，中国大陆访问太慢了且准备被阿里云取代的趋势，不太主流。
 
2 Dockerhub、阿里云这样的公共镜像仓库可能不太方便，涉及机密的公司不可能提供镜像给公网，所以需要创建一个本地私人仓库供给团队使用，基于公司内部项目构建镜像。
 
 Docker Registry是官方提供的工具，可以用于构建私有镜像仓库


## 2.1 下载镜像Docker Registry
docker pull registry 
![](image/Pasted%20image%2020240208115200.png)

![](image/Pasted%20image%2020240208115204.png)



## 2.2 运行私有库Registry，相当于本地有个私有Docker hub

docker run -d -p 5000:5000  -v /zzyyuse/myregistry/:/tmp/registry --privileged=true registry
默认情况，仓库被创建在容器的/var/lib/registry目录下，建议自行用容器卷映射，方便于宿主机联调


![](image/Pasted%20image%2020240208115244.png)


## 2.3 案例演示创建一个新镜像，ubuntu安装ifconfig命令
·          从Hub上下载ubuntu镜像到本地并成功运行
·          原始的Ubuntu镜像是不带着ifconfig命令的

![](image/Pasted%20image%2020240208115314.png)

·	外网连通的情况下，安装ifconfig命令并测试通过
docker容器内执行上述两条命令：
apt-get update
apt-get install net-tools

![](image/Pasted%20image%2020240208115330.png)

![](image/Pasted%20image%2020240208115336.png)



![](image/Pasted%20image%2020240208115342.png)


·	安装完成后，commit我们自己的新镜像
公式：
docker commit -m="提交的描述信息" -a="作者" 容器ID 要创建的目标镜像名:[标签名]
命令：在容器外执行，记得
docker commit -m="ifconfig cmd add" -a="zzyy" a69d7c825c4f zzyyubuntu:1.2

![](image/Pasted%20image%2020240208115410.png)

·   启动我们的新镜像并和原来的对比

1 官网是默认下载的Ubuntu没有ifconfig命令
2我们自己commit构建的新镜像，新增加了ifconfig功能，可以成功使用。

![](image/Pasted%20image%2020240208115427.png)

·	curl验证私服库上有什么镜像
 curl -XGET http://192.168.111.162:5000/v2/_catalog

可以看到，目前私服库没有任何镜像上传过。。。。。。
![](image/Pasted%20image%2020240208115448.png)

## 2.4 将新镜像zzyyubuntu:1.2修改符合私服规范的Tag

按照公式： docker   tag   镜像:Tag   Host:Port/Repository:Tag

自己host主机IP地址，填写同学你们自己的，不要粘贴错误，O(∩_∩)O

使用命令 docker tag 将zzyyubuntu:1.2 这个镜像修改为192.168.111.162:5000/zzyyubuntu:1.2

docker tag  zzyyubuntu:1.2  192.168.111.162:5000/zzyyubuntu:1.2

![](image/Pasted%20image%2020240208115505.png)



## 2.5 修改配置文件使之支持http

![](image/Pasted%20image%2020240208115811.png)


别无脑照着复制，registry-mirrors 配置的是国内阿里提供的镜像加速地址，不用加速的话访问官网的会很慢。
2个配置中间有个逗号 ','别漏了，这个配置是json格式的。

vim命令新增如下红色内容：vim /etc/docker/daemon.json
```
{
  "registry-mirrors": ["https://aa25jngu.mirror.aliyuncs.com"],
  "insecure-registries": ["192.168.111.162:5000"]
}
```


## 2.6 ·	push推送到私服库

docker push 192.168.111.162:5000/zzyyubuntu:1.2

![](image/Pasted%20image%2020240208115916.png)


·          curl验证私服库上有什么镜像2

curl -XGET http://192.168.111.162:5000/v2/_catalog

![](image/Pasted%20image%2020240208115927.png)


## 2.7 pull到本地并运行
docker pull 192.168.111.162:5000/zzyyubuntu:1.2

![](image/Pasted%20image%2020240208115945.png)

docker run -it 镜像ID /bin/bash

![](image/Pasted%20image%2020240208115955.png)


# 3 私有镜像库相关的知识 



## 3.1 htpasswd 命令 

更多见 https://www.bilibili.com/video/BV1sb411X7oe?p=145 

Registry 私有镜像中心中默认是没有用户认证功能的, 可以通过 htpasswd来实现用户认证 

htpasswd 是开源 web服务器Apache HTTP Server 的内置工具, 用于创建 更新 HTTP 基本认证的密码文件 

### 3.1.1 安装
![](image/Pasted%20image%2020240217134618.png)





# 4 发布到 dockerhub 

1 docker login
docker login -u xxx  , 然后让你输入密码 

![](image/Pasted%20image%2020240211004924.png)

2 然后 再 docker push imageid:版本号

![](image/Pasted%20image%2020240213122519.png)


使用docker tag 改个名字
先docker tag imageid username/repository:tagname 再docker push username/repository:tagname
docker tag 自己登录用户名/镜像名:tag 再push


docker push 后面家的 image名字:版本号， 这两个信息一定都要是本地image已经存在的。 
必须要带上版本号， 必须得加 username/repository 、  <mark>镜像名必须带自己的 dockerhub 用户名. 和仓库名</mark> 
其实 repository的名字 就是 自己给这个image 起的名字。 但是这个 repo 要存很多这个image 的不同版本 所以就变成了仓库 
push 的时候也是按照 image 里面的层级一层层push 的

![](image/Pasted%20image%2020240213123710.png)




